name: GHL to Abacus Integration

on:
  repository_dispatch:
    types: [ghl_message]

jobs:
  process-message:
    runs-on: ubuntu-latest
    
    steps:
    - name: Process GHL Chat Message
      run: |
        echo "Received message: ${{ github.event.client_payload.message }}"
        echo "From contact: ${{ github.event.client_payload.contact_id }}"
    
    - name: Send to Abacus ChatLLM
      id: abacus
      run: |
        response=$(curl -s -X POST "https://api.abacus.ai/api/v0/chatLLM" \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer ${{ secrets.ABACUS_API_KEY }}" \
          -d '{"message": "${{ github.event.client_payload.message }}"}')
        
        echo "Raw Abacus Response: $response"
        abacus_response=$(echo "$response" | jq -r '.response // .message // "Error: No response found"')
        echo "Extracted Response: $abacus_response"
        echo "abacus_response=$abacus_response" >> $GITHUB_OUTPUT
    
    - name: Send Response Back to GHL Demo
      run: |
        curl -X POST "https://services.leadconnectorhq.com/conversations/messages" \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer ${{ secrets.GHL_API_KEY_DEMO }}" \
          -H "Version: 2021-07-28" \
          -d '{
            "type": "Live_Chat",
            "locationId": "noDvw0ggtRl3u030FNat",
            "message": "${{ steps.abacus.outputs.abacus_response }}"
          }'
        
        echo "Response sent back to GHL Demo"
